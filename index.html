<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Discord Viewer v2+</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f2f3f5;
      color: #111;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #main {
      flex: 1;
      display: flex;
      overflow: hidden;
      margin-left: 0; /* ã‚µã‚¤ãƒ‰ãƒãƒ¼éè¡¨ç¤ºæ™‚ */
      transition: margin-left 0.3s ease;
    }
    #sidebar {
      width: 180px;
      background: #2c2f33;
      color: white;
      padding: 10px;
      display: none; /* åˆæœŸã¯éè¡¨ç¤º */
      position: fixed;
      top: 50px;
      left: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 1000;
    }
    #sidebar button {
      background: #5865F2;
      width: 100%;
      margin: 6px 0;
      border: none;
      color: white;
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
    }
    #sidebar button:hover {
      background: #4752c4;
    }
    #servers, #channels, #chat {
      width: 33.3%;
      padding: 10px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }
    #chat {
      border-right: none;
    }
    button {
      background: #5865F2;
      color: white;
      border: none;
      padding: 6px;
      margin: 2px 0;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
    }
    button:hover {
      background: #4752c4;
    }
    textarea, input {
      width: 100%;
      margin-top: 5px;
      box-sizing: border-box;
    }
    #logArea {
      height: 150px;
      overflow-y: auto;
      background: #1e1e1e;
      color: #ccc;
      font-size: 12px;
      padding: 6px;
      font-family: monospace;
      border-top: 2px solid #444;
      margin-left: 0;
      transition: margin-left 0.3s ease;
    }
    .error { color: #ff5555; }
    #historyBtn, #sidebarToggleBtn {
      position: fixed;
      top: 10px;
      z-index: 1100;
      background: #5865F2;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    #historyBtn {
      right: 10px;
    }
    #sidebarToggleBtn {
      left: 10px;
    }
    #historyPanel {
      position: fixed;
      top: 50px;
      right: 10px;
      width: 250px;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
    }
    #historyPanel h3 {
      margin: 0;
      padding: 8px;
      background: #eee;
      border-bottom: 1px solid #ccc;
    }
    .history-item {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .history-item:hover {
      background: #f0f0f0;
    }
    #credit {
      position: fixed;
      bottom: 5px;
      left: 10px;
      font-size: 12px;
      color: #666;
      font-family: monospace;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ãƒœã‚¿ãƒ³ -->
  <button id="sidebarToggleBtn">ğŸ“‚ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
  <!-- å±¥æ­´ãƒœã‚¿ãƒ³ -->
  <button id="historyBtn">ğŸ—„ï¸ å±¥æ­´</button>
  
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <div id="sidebar">
    <h3>ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
    <button onclick="alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼1ã‚¯ãƒªãƒƒã‚¯ï¼')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼1</button>
    <button onclick="alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼2ã‚¯ãƒªãƒƒã‚¯ï¼')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼2</button>
    <button onclick="alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼3ã‚¯ãƒªãƒƒã‚¯ï¼')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼3</button>
  </div>

  <!-- å±¥æ­´ãƒ‘ãƒãƒ« -->
  <div id="historyPanel">
    <h3>æœ€è¿‘ã®ãƒˆãƒ¼ã‚¯ãƒ³</h3>
    <div id="historyList"></div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div id="main">
    <div id="servers">
      <h2>ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³</h2>
      <input id="tokenInput" type="password" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³" />
      <button id="connectBtn">æ¥ç¶š</button>
      <h2>ğŸ“ ã‚µãƒ¼ãƒãƒ¼</h2>
      <div id="guildList"></div>
    </div>
    <div id="channels">
      <h2>ğŸ“š ãƒãƒ£ãƒ³ãƒãƒ«</h2>
      <div id="channelList"></div>
    </div>
    <div id="chat">
      <h2>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h2>
      <div id="messageList" style="height: 80%; overflow-y: auto;"></div>
      <textarea id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›"></textarea>
      <button id="sendBtn">é€ä¿¡</button>
    </div>
  </div>

  <!-- ãƒ­ã‚°è¡¨ç¤º -->
  <div id="logArea"></div>

  <!-- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ -->
  <div id="credit">Â© Discord Viewer v2+ - Powered by ãªã‚</div>

  <script>
    (() => {
      const logArea = document.getElementById("logArea");
      const log = (msg, err = false) => {
        const el = document.createElement("div");
        el.textContent = msg;
        if (err) el.classList.add("error");
        logArea.appendChild(el);
        logArea.scrollTop = logArea.scrollHeight;
      };

      const STORAGE_KEY = "tokenHistory";
      const historyBtn = document.getElementById("historyBtn");
      const historyPanel = document.getElementById("historyPanel");
      const historyList = document.getElementById("historyList");
      const tokenInput = document.getElementById("tokenInput");
      const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
      const sidebar = document.getElementById("sidebar");
      const main = document.getElementById("main");

      // å±¥æ­´ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿
      historyBtn.onclick = () => {
        historyPanel.style.display = historyPanel.style.display === "block" ? "none" : "block";
        renderHistory();
      };

      // ãƒˆãƒ¼ã‚¯ãƒ³å±¥æ­´æç”»
      function renderHistory() {
        const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        historyList.innerHTML = "";
        list.forEach(t => {
          const div = document.createElement("div");
          div.className = "history-item";
          div.textContent = t.slice(0, 5) + "..." + t.slice(-5);
          div.onclick = () => {
            tokenInput.value = t;
            historyPanel.style.display = "none";
          };
          historyList.appendChild(div);
        });
      }

      // ãƒˆãƒ¼ã‚¯ãƒ³å±¥æ­´ä¿å­˜
      function saveToken(token) {
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        history = [token, ...history.filter(t => t !== token)].slice(0, 10);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      }

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤ºåˆ‡æ›¿
      sidebarToggleBtn.onclick = () => {
        if (sidebar.style.display === "block") {
          sidebar.style.display = "none";
          main.style.marginLeft = "0";
          logArea.style.marginLeft = "0";
        } else {
          sidebar.style.display = "block";
          main.style.marginLeft = "180px";
          logArea.style.marginLeft = "180px";
        }
      };

      // ä»¥ä¸‹ã€Discord WebSocket/API ãªã©ã®ã‚³ãƒ¼ãƒ‰ã¯ãã®ã¾ã¾
      let socket = null;
      let token = "";
      let heartbeatInterval = null;
      let currentChannelId = null;

      document.getElementById("connectBtn").onclick = () => {
        token = tokenInput.value.trim();
        if (!token) return log("âš ï¸ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true);
        saveToken(token);
        socket = new WebSocket("wss://gateway.discord.gg/?v=9&encoding=json");
        socket.onopen = () => log("ğŸŒ æ¥ç¶šæˆåŠŸï¼");
        socket.onmessage = event => {
          const data = JSON.parse(event.data);
          if (data.op === 10) {
            heartbeatInterval = setInterval(() => {
              socket.send(JSON.stringify({ op: 1, d: null }));
            }, data.d.heartbeat_interval);
            socket.send(JSON.stringify({
              op: 2,
              d: {
                token,
                properties: { "$os": "linux", "$browser": "chrome", "$device": "chrome" }
              }
            }));
          }
          if (data.op === 0) {
            switch (data.t) {
              case "READY":
                log("âœ… ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†");
                const guilds = data.d.guilds;
                const guildList = document.getElementById("guildList");
                guildList.innerHTML = "";
                guilds.forEach(g => {
                  const b = document.createElement("button");
                  b.textContent = g.name;
                  b.onclick = () => loadChannels(g.id);
                  guildList.appendChild(b);
                });
                break;
              case "MESSAGE_CREATE":
                if (data.d.channel_id === currentChannelId) {
                  const msg = document.createElement("div");
                  msg.textContent = `${data.d.author.username}: ${data.d.content}` + (data.d.pinned ? " ğŸ“Œ" : "");
                  document.getElementById("messageList").appendChild(msg);
                }
                break;
            }
          }
        };
      };

      function api(path, opts = {}) {
        return fetch(`https://discord.com/api/v9/${path}`, {
          ...opts,
          headers: {
            Authorization: token,
            "Content-Type": "application/json"
          }
        }).then(r => r.json());
      }

      function loadChannels(guildId) {
        api(`guilds/${guildId}/channels`).then(chs => {
          const cl = document.getElementById("channelList");
          cl.innerHTML = "";
          chs.filter(c => c.type === 0).forEach(c => {
            const b = document.createElement("button");
            b.textContent = "#" + c.name;
            b.onclick = () => openChannel(c.id);
            cl.appendChild(b);
          });
        });
      }

      function openChannel(chId) {
        currentChannelId = chId;
        const msgList = document.getElementById("messageList");
        msgList.innerHTML = "";
        api(`channels/${chId}/messages?limit=20`).then(msgs => {
          msgs.reverse().forEach(m => {
            const div = document.createElement("div");
            div.textContent = `${m.author.username}: ${m.content}` + (m.pinned ? " ğŸ“Œ" : "");
            msgList.appendChild(div);
          });
        });
      }

      document.getElementById("sendBtn").onclick = () => {
        const input = document.getElementById("messageInput");
        const content = input.value.trim();
        if (!currentChannelId || !content) return;
        api(`channels/${currentChannelId}/messages`, {
          method: "POST",
          body: JSON.stringify({ content })
        }).then(() => {
          input.value = "";
          log("ğŸ“¤ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡");
        });
      };
    })();
  </script>
</body>
</html>
