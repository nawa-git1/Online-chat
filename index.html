<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Discord Viewer v2</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f2f3f5;
      color: #111;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #servers, #channels, #chat {
      width: 33.3%;
      padding: 10px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }
    #chat {
      border-right: none;
    }
    button {
      background: #5865F2;
      color: white;
      border: none;
      padding: 6px;
      margin: 2px 0;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #4752c4;
    }
    textarea, input {
      width: 100%;
      margin-top: 5px;
      box-sizing: border-box;
    }
    #logArea {
      height: 150px;
      overflow-y: auto;
      background: #1e1e1e;
      color: #ccc;
      font-size: 12px;
      padding: 6px;
      font-family: monospace;
      border-top: 2px solid #444;
    }
    .error {
      color: #ff5555;
    }
  </style>
</head>
<body>
  <div id="main">
    <div id="servers">
      <h2>🔑 トークン</h2>
      <input id="tokenInput" type="password" placeholder="ユーザートークン" />
      <button id="connectBtn">接続</button>
      <h2>🧭 サーバー</h2>
      <div id="guildList"></div>
    </div>
    <div id="channels">
      <h2>📚 チャンネル</h2>
      <div id="channelList"></div>
    </div>
    <div id="chat">
      <h2>💬 チャット</h2>
      <div id="messageList" style="height: 80%; overflow-y: auto;"></div>
      <textarea id="messageInput" placeholder="メッセージを入力"></textarea>
      <button id="sendBtn">送信</button>
    </div>
  </div>
  <div id="logArea"></div>

  <script>
    (() => {
      const logArea = document.getElementById("logArea");
      const log = (msg, err = false) => {
        const el = document.createElement("div");
        el.textContent = msg;
        if (err) el.classList.add("error");
        logArea.appendChild(el);
        logArea.scrollTop = logArea.scrollHeight;
      };

      let socket = null;
      let token = "";
      let heartbeatInterval = null;
      let currentChannelId = null;

      function connect() {
        token = document.getElementById("tokenInput").value.trim();
        if (!token) return log("⚠️ トークンを入力してください", true);

        socket = new WebSocket("wss://gateway.discord.gg/?v=9&encoding=json");
        socket.onopen = () => log("🌐 接続成功！");
        socket.onerror = (e) => log("❌ WebSocketエラー", true);
        socket.onclose = (e) => {
          log("🔴 接続終了", true);
          if (heartbeatInterval) clearInterval(heartbeatInterval);
        };

        socket.onmessage = (event) => {
          let data = JSON.parse(event.data);
          if (data.op === 10) {
            heartbeatInterval = setInterval(() => {
              socket.send(JSON.stringify({ op: 1, d: null }));
            }, data.d.heartbeat_interval);
            socket.send(JSON.stringify({
              op: 2,
              d: {
                token,
                properties: {
                  "$os": "linux",
                  "$browser": "chrome",
                  "$device": "chrome"
                }
              }
            }));
          }

          if (data.op === 0) {
            switch (data.t) {
              case "READY":
                log("✅ ログイン完了");
                const guilds = data.d.guilds;
                const guildList = document.getElementById("guildList");
                guildList.innerHTML = "";
                guilds.forEach(g => {
                  const b = document.createElement("button");
                  b.textContent = g.name;
                  b.onclick = () => loadChannels(g.id);
                  guildList.appendChild(b);
                });
                break;

              case "CHANNEL_CREATE":
                const chbtn = document.createElement("button");
                chbtn.textContent = "#" + data.d.name;
                chbtn.onclick = () => openChannel(data.d.id);
                document.getElementById("channelList").appendChild(chbtn);
                break;

              case "MESSAGE_CREATE":
                if (data.d.channel_id === currentChannelId) {
                  const msg = document.createElement("div");
                  msg.id = "msg-" + data.d.id;
                  msg.textContent = `${data.d.author.username}: ${data.d.content}`;
                  document.getElementById("messageList").appendChild(msg);
                }
                break;

              case "MESSAGE_UPDATE":
                const updated = document.getElementById("msg-" + data.d.id);
                if (updated) updated.textContent = `(編集済) ${data.d.content}`;
                break;

              case "MESSAGE_DELETE":
                const del = document.getElementById("msg-" + data.d.id);
                if (del) {
                  del.textContent = "(削除済みのメッセージ)";
                  del.style.color = "#aaa";
                }
                break;

              case "MESSAGE_REACTION_ADD":
                const reacted = document.getElementById("msg-" + data.d.message_id);
                if (reacted) reacted.textContent += ` ❤️ [${data.d.emoji.name}]`;
                break;
            }
          }
        };
      }

      function api(path, opts = {}) {
        return fetch(`https://discord.com/api/v9/${path}`, {
          ...opts,
          headers: {
            Authorization: token,
            "Content-Type": "application/json"
          }
        }).then(r => r.json());
      }

      function loadChannels(guildId) {
        api(`guilds/${guildId}/channels`).then(chs => {
          const cl = document.getElementById("channelList");
          cl.innerHTML = "";
          chs.filter(c => c.type === 0).forEach(c => {
            const b = document.createElement("button");
            b.textContent = "#" + c.name;
            b.onclick = () => openChannel(c.id);
            cl.appendChild(b);
          });
        });
      }

      function openChannel(chId) {
        currentChannelId = chId;
        const msgList = document.getElementById("messageList");
        msgList.innerHTML = "";
        api(`channels/${chId}/messages?limit=20`).then(msgs => {
          msgs.reverse().forEach(m => {
            const div = document.createElement("div");
            div.id = "msg-" + m.id;
            div.textContent = `${m.author.username}: ${m.content}`;
            msgList.appendChild(div);
          });
        });
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const content = input.value.trim();
        if (!currentChannelId || !content) return;
        api(`channels/${currentChannelId}/messages`, {
          method: "POST",
          body: JSON.stringify({ content })
        }).then(() => {
          input.value = "";
          log("📤 メッセージ送信");
        });
      }

      document.getElementById("connectBtn").onclick = connect;
      document.getElementById("sendBtn").onclick = sendMessage;
    })();
  </script>
</body>
</html>
